<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Pikachu (Version 1.0.6)</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden; /* Ngăn thanh cuộn của body */
            background-color: #87ceeb;
            background-image: url('body.jpg'); /* Đường dẫn đến ảnh nền bạn muốn */
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            
            display: grid;
            grid-template-areas: 
                "game-area"
                "controls-area"; /* Mặc định mobile dọc: controls nằm dưới game */
            grid-template-rows: 1fr auto; 
            grid-template-columns: 1fr;
            
            justify-items: center; 
            align-items: center;   
            
            min-height: 100vh;
            width: 100vw; 
            box-sizing: border-box; 
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation; 
            font-family: 'Roboto', sans-serif;
            color: white;
        }

        #game-container {
            grid-area: game-area; 
            width: 1280px; /* Kích thước tham chiếu */
            height: 720px; /* Kích thước tham chiếu */
            border: 5px solid #333;
            background-color: #aaddff;
            position: relative; 
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transform-origin: center center; 
            transform: scale(1); 
            transition: transform 0.1s ease-out; 
            
            max-width: 99vw; 
            max-height: 99vh; 
        }

        #game-world {
            position: absolute;
            top: 0;
            left: 0;
            width: 2500px; /* Chiều rộng thế giới game */
            height: 100%;
            background-image: url('game.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center bottom;
        }

        #player {
            width: 60px;
            height: 60px;
            background-image: url('https://www.pngall.com/wp-content/uploads/5/Pokemon-Pikachu-PNG-High-Quality-Image.png');
            background-size: contain;
            background-position: center bottom;
            background-repeat: no-repeat;
            position: absolute;
            image-rendering: pixelated;
            z-index: 10;
            transition: transform 0.1s ease-out; 
        }

        #player.flipped {
            transform: scaleX(-1);
        }

        .platform {
            background-image: url('dat2.png');
            background-size: cover;
            background-repeat: repeat-x;
            position: absolute;
            height: 50px;
            z-index: 5;
        }

        .obstacle, .hazard, .moving-obstacle {
            background-color: #8B4513;
            position: absolute;
            background-image: url('khucgo.jpg');
            background-size: cover;
            background-repeat: repeat-x;
            border: 2px solid #555;
            z-index: 6;
        }
        .hazard {
            background-color: #ffffff;
            border: 2px solid #8B0000;
            background-image: url('lua4-1.png');
            background-size: cover;
            background-repeat: repeat-x;
            border: none;
            z-index: 6;
        }
        .moving-obstacle {
            background-color: #56e6ff;
            border: 2px solid #333;
            background-image: url('may1-1.png');
            background-size: cover;
            background-repeat: repeat-x;
            z-index: 6;
        }

        #finish-line {
            width: 30px;
            height: 120px;
            background-color: rgb(92, 51, 4);
            position: absolute;
            background-image: url('cua-cong-2.png');
            background-size: cover;
            background-repeat: repeat-x;
            border: 2px dashed #000;
            z-index: 7;
        }

        #time-display {
            position: absolute;
            top: 10px;
            left: 10px;
            font-family: 'Roboto', sans-serif;
            font-weight: bold;
            font-size: 1.2em; 
            color: white;
            text-shadow: 2px 2px 3px black;
            z-index: 20;
            pointer-events: none; 
        }
        
        #coin-display {
            position: absolute;
            top: 10px;
            right: 10px;
            font-family: 'Roboto', sans-serif;
            font-weight: bold;
            font-size: 1.2em;
            color: gold;
            text-shadow: 2px 2px 3px black;
            z-index: 20;
            pointer-events: none;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }

        #recharge-overlay {
            display: none; /* Mặc định ẩn, sẽ được JS bật lên */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            flex-direction: column;
            font-size: 1.8em;
            font-family: 'Roboto', sans-serif;
        }

        #recharge-overlay button {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: background-color 0.3s ease, transform 0.2s;
        }

        #recharge-overlay button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        #recharge-overlay button:active {
            transform: scale(0.95);
        }

        #recharge-overlay p {
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        #game-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px 60px;
            border-radius: 15px;
            font-family: 'Roboto', sans-serif;
            font-size: 2.2em;
            display: none;
            z-index: 100;
            text-align: center;
            border: 3px solid #ffcc00;
            text-shadow: 2px 2px 5px black;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.6);
            width: 80%; 
            max-width: 600px;
            box-sizing: border-box;
            pointer-events: auto; /* Quan trọng để nút bên trong có thể click */
        }
        #game-message p {
            margin-bottom: 1.5vw;
            font-size: 0.8em;
            font-weight: bold;
        }
        #game-message ul {
            list-style: none;
            padding: 0;
            margin-top: 1vw;
            max-height: 10vh; 
            overflow-y: auto;
            border-top: 1px dashed rgba(255,255,255,0.3);
            padding-top: 1vw;
        }
        #game-message li {
            margin-bottom: 0.3vw;
        }

        #game-message button {
            margin-top: 2vw;
            padding: 1vw 2vw; 
            font-size: 1.2em; 
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.2s;
            font-family: 'Roboto', sans-serif;
            pointer-events: auto; 
        }
        #game-message button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        /* Mobile Controls (Portrait/Default) */
        #mobile-controls {
            grid-area: controls-area; 
            width: 100%; 
            max-width: 900px; 
            padding: 10px; 
            display: flex;
            justify-content: space-around; 
            align-items: center;
            z-index: 1000;
            background-color: transparent; 
            border-radius: 15px;
            opacity: 0.9; 
            box-sizing: border-box;
            gap: 15px; 
            pointer-events: auto;
            display: none; 
        }
        .control-group {
            display: flex;
            gap: 25px; 
        }
        .control-button {
            width: 15vw; 
            height: 15vw; 
            max-width: 80px; 
            max-height: 80px; 
            min-width: 60px; 
            min-height: 60px; 
            
            background-color: rgba(0, 123, 255, 0.7); 
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 6vw; 
            max-font-size: 35px; 
            min-font-size: 28px; 

            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            transition: background-color 0.2s, transform 0.2s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .control-button:active {
            background-color: rgba(0, 86, 179, 0.7); 
            transform: scale(0.9); 
        }

        /* Mobile Controls (Landscape) - TỐI ƯU VỊ TRÍ NÚT */
        #left-controls-area {
            grid-area: controls-left;
            display: none; 
            flex-direction: column;
            justify-content: center; /* Căn giữa theo chiều dọc */
            align-items: center;     /* Căn giữa theo chiều ngang */
            gap: 15px;
            background-color: transparent; 
            height: 100%;
            box-sizing: border-box;
            /* Thêm padding để đẩy các nút vào bên trong khỏi mép màn hình */
            padding-left: 10px; 
        }
        #right-controls-area {
            grid-area: controls-right;
            display: none; 
            flex-direction: column;
            justify-content: center; /* Căn giữa theo chiều dọc */
            align-items: center;     /* Căn giữa theo chiều ngang */
            gap: 15px; 
            background-color: transparent; 
            height: 100%;
            box-sizing: border-box;
            /* Thêm padding để đẩy các nút vào bên trong khỏi mép màn hình */
            padding-right: 10px; 
        }

        /* CSS cho phần hướng dẫn */
        #game-instructions {
            position: absolute;
            top: 20px; /* Điều chỉnh vị trí từ trên xuống */
            left: 20px; /* Điều chỉnh vị trí từ trái sang */
            background-color: rgba(0, 0, 0, 0.7); /* Nền tối trong suốt */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9em; /* Kích thước chữ */
            z-index: 50; /* Đảm bảo nằm trên các yếu tố game nhưng dưới game message */
            display: block; /* Mặc định hiển thị */
            transition: opacity 0.5s ease-out; /* Hiệu ứng mờ dần */
            pointer-events: none; /* Quan trọng: Không chặn click/touch vào game */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            text-shadow: 1px 1px 2px black;
        }

        #game-instructions p {
            margin: 5px 0;
            line-height: 1.4;
        }


        /* MEDIA QUERIES để tối ưu bố cục và kích thước */

        /* Mobile dọc (portrait) */
        @media (orientation: portrait) {
            body {
                grid-template-areas: 
                    "game-area"
                    "controls-area";
                grid-template-rows: 1fr auto;
                grid-template-columns: 1fr;
            }
            #game-container {
                max-width: 95vw;
                max-height: 70vh; 
            }
            #mobile-controls {
                width: 90%; 
                max-width: 500px;
                margin-top: 15px; 
            }
            .control-button {
                width: 15vw; 
                height: 15vw;
                min-width: 55px; 
                min-height: 55px; 
                font-size: 5vw; 
                min-font-size: 26px; 
            }
            /* ĐIỀU CHỈNH KÍCH THƯỚC THÔNG BÁO KẾT THÚC GAME CHO PORTRAIT */
            #game-message {
                padding: 8px; 
                font-size: 0.9em; 
            }
            #game-message p {
                font-size: 0.6em; 
                margin-bottom: 1vw; 
            }
            #game-message ul {
                font-size: 0.45em; 
                max-height: 8vh; 
                padding-top: 0.8vw; 
            }
            #game-message button {
                font-size: 0.9em; 
                padding: 0.8vw 1.5vw; 
            }
            #game-instructions {
                top: 10px;
                left: 10px;
                font-size: 0.7em; /* Nhỏ hơn trên mobile */
                padding: 8px 12px;
            }
        }

        /* Mobile ngang (landscape) và Tablet */
        @media (orientation: landscape) and (max-width: 999px) {
            body {
                grid-template-areas: 
                    "controls-left game-area controls-right";
                /* Tối ưu hóa grid columns để căn chỉnh nút */
                /* Sử dụng minmax để các cột controls có chiều rộng tối thiểu và linh hoạt */
                grid-template-columns: minmax(60px, 1fr) 4fr minmax(60px, 1fr); 
                grid-template-rows: 1fr; 
            }
            #game-container {
                max-width: 80vw; 
                max-height: 98vh; 
            }
            #mobile-controls {
                display: none !important; 
            }
            #left-controls-area {
                display: flex; 
            }
            #right-controls-area {
                display: flex; 
            }
            .control-button {
                width: 10vw; 
                height: 10vw;
                max-width: 70px;
                max-height: 70px;
                min-width: 50px;
                min-height: 50px;
                font-size: 4vw;
                max-font-size: 28px;
                min-font-size: 20px;
            }
            /* ĐIỀU CHỈNH KÍCH THƯỚC THÔNG BÁO KẾT THÚC GAME CHO LANDSCAPE */
            #game-message {
                padding: 12px; 
                font-size: 1.2em; 
            }
            #game-message p {
                    font-size: 0.7em; 
                    margin-bottom: 0.8vw;
                }
            #game-message ul {
                font-size: 0.55em; 
                max-height: 9vh;
                padding-top: 0.7vw;
            }
            #game-message button {
                font-size: 1.0em; 
                padding: 0.9vw 1.8vw;
            }
            #game-instructions {
                top: 10px;
                left: 10px;
                font-size: 0.7em; /* Nhỏ hơn trên mobile */
                padding: 8px 12px;
            }
        }


        /* Cho màn hình lớn (PC) */
        @media (min-width: 1000px) {
            body {
                grid-template-areas: "game-area"; 
                grid-template-rows: 1fr;
                grid-template-columns: 1fr;
            }
            #time-display {
                font-size: 1.3em;
                top: 15px;
                left: 15px;
            }
            #game-message {
                padding: 40px; 
                font-size: 2.2em; 
            }
            #mobile-controls, #left-controls-area, #right-controls-area {
                display: none !important; 
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-world">
            <div id="player"></div>
            <div id="finish-line"></div>
            <div id="game-instructions">
                <p><strong>Hướng dẫn:</strong></p>
                <p>A: Di chuyển trái</p>
                <p>D: Di chuyển phải</p>
                <p>Space: Nhảy</p>
                <p>Đi đến Cổng để thắng!</p>
            </div>
        </div>
    </div>

    <div id="time-display">Thời gian: 00:00</div>
    <div id="coin-display">Xu: <span id="coin-count">0</span></div>
    <div id="game-message">
        </div>

    <div id="recharge-overlay">
        <p>Bạn đã hết xu!</p>
        <p>Cần xu để tiếp tục chơi.</p>
        <button id="recharge-button">Nhận thêm xu miễn phí</button>
    </div>

    <div id="mobile-controls">
        <div class="control-group">
            <button class="control-button" id="left-button">←</button>
            <button class="control-button" id="right-button">→</button>
        </div>
        <button class="control-button" id="jump-button">↑</button>
    </div>

    <div id="left-controls-area">
        <button class="control-button" id="left-button-landscape">←</button>
        <button class="control-button" id="right-button-landscape">→</button>
    </div>
    <div id="right-controls-area">
        <button class="control-button" id="jump-button-landscape">↑</button>
    </div>

    <script>
        const player = document.getElementById('player');
        const gameContainer = document.getElementById('game-container');
        const gameWorld = document.getElementById('game-world');
        let finishLine = document.getElementById('finish-line');
        const gameMessage = document.getElementById('game-message');
        const timeDisplay = document.getElementById('time-display');
        const gameInstructions = document.getElementById('game-instructions');

        // Mobile Controls elements (portrait/default)
        const leftButton = document.getElementById('left-button');
        const rightButton = document.getElementById('right-button');
        const jumpButton = document.getElementById('jump-button');

        // Mobile Controls elements (landscape)
        const leftButtonLandscape = document.getElementById('left-button-landscape');
        const rightButtonLandscape = document.getElementById('right-button-landscape');
        const jumpButtonLandscape = document.getElementById('jump-button-landscape');

        let startTime = 0;
        let elapsedTime = 0;
        let timerInterval;

        let winHistory = JSON.parse(localStorage.getItem('gameWinHistory')) || [];

        let playerX = 50;
        let playerY = 0;
        const playerBaseWidth = 60;
        const playerBaseHeight = 60;
        let playerActualWidth = playerBaseWidth;
        let playerActualHeight = playerBaseHeight;

        const hitboxXOffset = 10; 
        const hitboxYOffset = 5; 

        const deathFallThreshold = -100; 

        let isJumping = false;
        let isMovingLeft = false;
        let isMovingRight = false;
        let isGameOver = true; // Bắt đầu là true để hiển thị màn hình chào mừng
        let isOnPlatform = false; 

        const moveAcceleration = 1.2;
        const friction = 0.8;
        const maxSpeed = 6;
        const jumpStrength = 15.5; 
        const gravity = 0.55;     
        let xVelocity = 0;
        let yVelocity = 0;

        let cameraX = 0;
        let facingRight = true;

        let lastFrameTime = 0;
        const targetFPS = 60;

        let gameElements = [];
        let movingObstacles = [];

        // Kích thước game gốc (reference size)
        const gameBaseWidth = 1280;
        const gameBaseHeight = 720;
        const gameAspectRatio = gameBaseWidth / gameBaseHeight; 

        // --- CÁC GIỚI HẠN SCALE ---
        const minGameScale = 0.8; 
        const maxGameScale = 1.6; 

        // BIẾN MỚI: Kích thước hiển thị thực tế của game container sau khi scaling
        let currentEffectiveGameWidth = gameBaseWidth;
        let currentEffectiveGameHeight = gameBaseHeight;

        // BIẾN MỚI: Độ mượt của camera
        const CAMERA_SMOOTHNESS = 0.08; 
        
        // BIẾN MỚI: Vị trí trên màn hình mà nhân vật sẽ được "neo" khi camera cuộn
        const playerAnchorXOnScreen = gameBaseWidth * 0.25; 

        // =======================================================================
        // CÁC HẰNG SỐ VÀ BIẾN CHO HỆ THỐNG XU
        // =======================================================================
        let coinsAvailable = parseInt(localStorage.getItem('pikachuCoins')) || 5; // Lấy xu từ localStorage, mặc định 5
        const COST_PER_PLAY = 1;      // Chi phí để bắt đầu một lượt chơi/level
        const REWARD_PER_LEVEL = 2;   // Số xu nhận được khi hoàn thành một level
        const RECHARGE_AMOUNT = 5;    // Số xu nhận được khi "nạp thêm"

        const coinDisplay = document.getElementById('coin-count'); // Phần tử hiển thị số xu
        const rechargeOverlay = document.getElementById('recharge-overlay'); // Overlay nạp xu
        const rechargeButton = document.getElementById('recharge-button'); // Nút nạp xu
        // =======================================================================


        // --- Cấu trúc Level ---
        const gameLevels = {
            level1: {
                worldWidth: 6000, 
                initialPlayerX: 50,
                initialPlayerY: 50, 
                finishLine: { left: 4950, bottom: 50, width: 30, height: 120 }, 
                elements: [
                    { type: 'platform', left: 0, width: 200, height: 50, bottom: 0 },
                    { type: 'platform', left: 300, width: 100, height: 50, bottom: 0 },
                    { type: 'platform', left: 500, width: 150, height: 50, bottom: 0 },
                    { type: 'platform', left: 750, width: 120, height: 50, bottom: 80 },
                    { type: 'platform', left: 950, width: 100, height: 50, bottom: 0 },
                    { type: 'platform', left: 1150, width: 180, height: 50, bottom: 0 },
                    { type: 'platform', left: 1400, width: 100, height: 50, bottom: 120 },
                    { type: 'platform', left: 1600, width: 150, height: 50, bottom: 0 },
                    { type: 'platform', left: 1850, width: 150, height: 50, bottom: 0 },
                    { type: 'platform', left: 2100, width: 200, height: 50, bottom: 0 },
                    { type: 'platform', left: 2400, width: 100, height: 50, bottom: 0 },

                    { type: 'obstacle', left: 150, width: 50, height: 30, bottom: 50 },
                    { type: 'obstacle', left: 550, width: 70, height: 60, bottom: 50 },
                    { type: 'obstacle', left: 800, width: 50, height: 30, bottom: 130 },
                    { type: 'obstacle', left: 1450, width: 50, height: 40, bottom: 170 },
                    { type: 'obstacle', left: 1650, width: 80, height: 70, bottom: 50 },
                    { type: 'obstacle', left: 2200, width: 50, height: 50, bottom: 50 },

                    { type: 'hazard', left: 350, width: 30, height: 15, bottom: 50 },
                    { type: 'hazard', left: 1000, width: 60, height: 15, bottom: 50 },
                    { type: 'hazard', left: 1950, width: 40, height: 20, bottom: 50 },

                    { type: 'moving-obstacle', left: 600, width: 60, height: 40, bottom: 100, range: 100, speed: 1.5 },
                    { type: 'moving-obstacle', left: 1250, width: 80, height: 50, bottom: 50, range: 150, speed: 1.2 },
                    { type: 'moving-obstacle', left: 1700, width: 50, height: 30, bottom: 100, range: 80, speed: 2 },
                    
                    // --- THÊM CÁC ELEMENTS MỚI CHO PHẦN BẢN ĐỒ DÀI HƠN ---
                    { type: 'platform', left: 2500, width: 100, height: 50, bottom: 0 },
                    { type: 'obstacle', left: 2650, width: 60, height: 50, bottom: 50 },
                    { type: 'platform', left: 2800, width: 150, height: 50, bottom: 0 },
                    { type: 'hazard', left: 2900, width: 30, height: 60, bottom: 50 },
                    { type: 'platform', left: 3000, width: 200, height: 50, bottom: 80 },
                    { type: 'moving-obstacle', left: 3200, width: 170, height: 45, bottom: 130, range: 100, speed: 1.7 },
                    { type: 'platform', left: 3400, width: 180, height: 50, bottom: 0 },
                    { type: 'platform', left: 3600, width: 150, height: 50, bottom: 0 },
                    { type: 'obstacle', left: 3800, width: 70, height: 60, bottom: 50 },
                    { type: 'hazard', left: 3850, width: 40, height: 70, bottom: 50 },
                    { type: 'platform', left: 4000, width: 100, height: 50, bottom: 100 },
                    { type: 'moving-obstacle', left: 4200, width: 160, height: 30, bottom: 50, range: 100, speed: 2.1 },
                    { type: 'platform', left: 4400, width: 150, height: 50, bottom: 0 },
                    { type: 'obstacle', left: 4650, width: 80, height: 50, bottom: 50 },
                    { type: 'platform', left: 4800, width: 180, height: 50, bottom: 0 }
                ]
            },
            level2: {
                worldWidth: 7000, // Level 2 có thể dài hơn
                initialPlayerX: 50,
                initialPlayerY: 50, 
                finishLine: { left: 5900, bottom: 50, width: 30, height: 120 },
                elements: [
                    { type: 'platform', left: 0, width: 250, height: 50, bottom: 0 },
                    { type: 'hazard', left: 300, width: 60, height: 25, bottom: 50 },
                    { type: 'platform', left: 450, width: 150, height: 50, bottom: 0 },
                    { type: 'moving-obstacle', left: 700, width: 80, height: 50, bottom: 100, range: 180, speed: 1.5 },
                    { type: 'platform', left: 900, width: 120, height: 50, bottom: 120 },
                    { type: 'obstacle', left: 1100, width: 70, height: 60, bottom: 50 },
                    { type: 'platform', left: 1300, width: 200, height: 50, bottom: 0 },
                    { type: 'hazard', left: 1550, width: 40, height: 20, bottom: 50 },
                    { type: 'platform', left: 1700, width: 180, height: 50, bottom: 0 },
                    { type: 'moving-obstacle', left: 1950, width: 70, height: 45, bottom: 130, range: 150, speed: 1.7 },
                    { type: 'platform', left: 2200, width: 100, height: 50, bottom: 0 },
                    { type: 'obstacle', left: 2350, width: 90, height: 70, bottom: 50 },
                    { type: 'platform', left: 2550, width: 150, height: 50, bottom: 0 },
                    { type: 'hazard', left: 2750, width: 50, height: 20, bottom: 50 },
                    { type: 'platform', left: 2900, width: 220, height: 50, bottom: 80 },
                    { type: 'moving-obstacle', left: 3150, width: 60, height: 30, bottom: 50, range: 120, speed: 2.1 },
                    { type: 'platform', left: 3400, width: 180, height: 50, bottom: 0 },
                    { type: 'obstacle', left: 3600, width: 80, height: 60, bottom: 50 },
                    { type: 'platform', left: 3800, width: 120, height: 50, bottom: 0 },
                    { type: 'hazard', left: 3950, width: 30, height: 15, bottom: 50 },
                    { type: 'platform', left: 4100, width: 200, height: 50, bottom: 100 },
                    { type: 'moving-obstacle', left: 4350, width: 75, height: 40, bottom: 150, range: 100, speed: 1.9 },
                    { type: 'platform', left: 4600, width: 250, height: 50, bottom: 0 },
                    { type: 'obstacle', left: 4850, width: 60, height: 50, bottom: 50 },
                    { type: 'platform', left: 5050, width: 150, height: 50, bottom: 0 },
                    { type: 'hazard', left: 5250, width: 40, height: 20, bottom: 50 },
                    { type: 'platform', left: 5400, width: 200, height: 50, bottom: 80 },
                    { type: 'moving-obstacle', left: 5650, width: 70, height: 35, bottom: 50, range: 150, speed: 2.3 },
                    { type: 'platform', left: 5800, width: 150, height: 50, bottom: 0 }
                ]
            }
        };

        let currentLevelIndex = 1;

        function resizeGame() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            let scale = 1;
            const viewportAspectRatio = viewportWidth / viewportHeight;

            if (viewportAspectRatio > gameAspectRatio) {
                scale = viewportHeight / gameBaseHeight;
            } else {
                scale = viewportWidth / gameBaseWidth;
            }

            scale = Math.min(scale, maxGameScale);
            scale = Math.max(scale, minGameScale);

            gameContainer.style.transform = `scale(${scale})`;
            
            currentEffectiveGameWidth = gameBaseWidth * scale;
            currentEffectiveGameHeight = gameBaseHeight * scale;

            const mobileControlsPortrait = document.getElementById('mobile-controls');
            const mobileControlsLeftLandscape = document.getElementById('left-controls-area');
            const mobileControlsRightLandscape = document.getElementById('right-controls-area');

            // Hiển thị/ẩn các bộ điều khiển dựa trên hướng màn hình và kích thước
            if (viewportWidth < 1000 && viewportWidth / viewportHeight < 1) { // Mobile Portrait
                mobileControlsPortrait.style.display = 'flex';
                mobileControlsLeftLandscape.style.display = 'none';
                mobileControlsRightLandscape.style.display = 'none';
            } else if (viewportWidth < 1000 && viewportWidth / viewportHeight >= 1) { // Mobile Landscape
                mobileControlsPortrait.style.display = 'none';
                mobileControlsLeftLandscape.style.display = 'flex';
                mobileControlsRightLandscape.style.display = 'flex';
            } else { // PC
                mobileControlsPortrait.style.display = 'none';
                mobileControlsLeftLandscape.style.display = 'none';
                mobileControlsRightLandscape.style.display = 'none';
            }
        }

        window.addEventListener('resize', resizeGame);

        // =======================================================================
        // HÀM XU (ĐIỀU CHỈNH)
        // =======================================================================
        function updateCoinDisplay() {
            coinDisplay.textContent = coinsAvailable;
            localStorage.setItem('pikachuCoins', coinsAvailable); // Lưu xu vào localStorage
        }

        function showRechargeOverlay() {
            // Dừng game và timer
            cancelAnimationFrame(window.animationFrameId); 
            clearInterval(timerInterval); 
            isGameOver = true; // Đảm bảo game dừng hoàn toàn

            rechargeOverlay.style.display = 'flex'; // Hiển thị overlay nạp xu
            
            // Gỡ bỏ listener cũ để tránh trùng lặp
            rechargeButton.removeEventListener('click', handleRecharge);
            rechargeButton.removeEventListener('touchend', handleRechargeTouch);

            // Thêm listener mới
            rechargeButton.addEventListener('click', handleRecharge);
            rechargeButton.addEventListener('touchend', handleRechargeTouch);
        }

        function handleRecharge() {
            coinsAvailable += RECHARGE_AMOUNT; // Nạp thêm xu
            updateCoinDisplay(); // Cập nhật hiển thị xu
            rechargeOverlay.style.display = 'none'; // Ẩn overlay nạp xu

            // Sau khi nạp, hiển thị thông báo hỏi chơi tiếp cần 1 xu
            gameMessage.innerHTML = `<p>Bạn đã nhận ${RECHARGE_AMOUNT} xu!</p><p>Chơi tiếp cần ${COST_PER_PLAY} xu.</p><button id="start-after-recharge">Bắt đầu</button>`;
            gameMessage.style.display = 'block';

            const startAfterRechargeButton = document.querySelector('#game-message #start-after-recharge');
            if (startAfterRechargeButton) {
                // Đảm bảo gỡ bỏ listener trước khi thêm để tránh gọi nhiều lần
                startAfterRechargeButton.removeEventListener('click', initializeGame);
                startAfterRechargeButton.removeEventListener('touchend', (e) => { e.preventDefault(); initializeGame(); });
            }
            startAfterRechargeButton.addEventListener('click', initializeGame);
            startAfterRechargeButton.addEventListener('touchend', (e) => { e.preventDefault(); initializeGame(); });
        }

        function handleRechargeTouch(e) {
            e.preventDefault();
            handleRecharge();
        }
        // =======================================================================

        function loadLevel(levelData) {
            // Xóa tất cả các element cũ trừ player và finishLine (sẽ được cập nhật vị trí)
            const elementsToRemove = Array.from(gameWorld.children).filter(child => 
                child.id !== 'player' && child.id !== 'finish-line' && child.id !== 'game-instructions');
            elementsToRemove.forEach(el => gameWorld.removeChild(el));

            gameElements = [];
            movingObstacles = [];

            gameWorld.style.width = levelData.worldWidth + 'px';

            // Cập nhật vị trí finishLine
            finishLine.style.left = levelData.finishLine.left + 'px';
            finishLine.style.bottom = levelData.finishLine.bottom + 'px';
            finishLine.style.width = levelData.finishLine.width + 'px';
            finishLine.style.height = levelData.finishLine.height + 'px';

            // Thêm lại các element của level mới
            levelData.elements.forEach(data => {
                const el = document.createElement('div');
                el.classList.add(data.type);
                el.style.left = data.left + 'px';
                el.style.bottom = data.bottom + 'px';
                el.style.width = data.width + 'px';
                el.style.height = data.height + 'px';
                gameWorld.appendChild(el);
                gameElements.push(el);

                if (data.type === 'moving-obstacle') {
                    movingObstacles.push({
                        element: el,
                        initialLeft: data.left,
                        range: data.range,
                        speed: data.speed,
                        direction: 1 
                    });
                }
            });
            // Đảm bảo player luôn là con cuối cùng để hiển thị trên cùng
            gameWorld.appendChild(player);
            gameWorld.appendChild(gameInstructions); // Đảm bảo hướng dẫn luôn ở trên
        }

        function updateTimer() {
            if (isGameOver) return;
            elapsedTime = performance.now() - startTime;
            const minutes = Math.floor(elapsedTime / 60000);
            const seconds = Math.floor((elapsedTime % 60000) / 1000);
            const milliseconds = Math.floor((elapsedTime % 1000) / 10);
            timeDisplay.textContent = `Thời gian: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
        }

        function updatePlayerPosition() {
            player.style.left = playerX + 'px';
            player.style.bottom = playerY + 'px';

            if (xVelocity < 0 && facingRight) {
                player.classList.add('flipped');
                facingRight = false;
            } else if (xVelocity > 0 && !facingRight) {
                player.classList.remove('flipped');
                facingRight = true;
            }
        }

        function jump() {
            // Đảm bảo chỉ nhảy khi đang đứng trên nền
            if (isOnPlatform) { 
                isJumping = true;
                yVelocity = jumpStrength;
                isOnPlatform = false; // Ngay lập tức đặt false để tránh nhảy đúp khi đang bay lên
            }
        }

        function getElementRect(element) {
            const left = parseFloat(element.style.left); 
            const bottom = parseFloat(element.style.bottom); 
            const width = parseFloat(element.style.width); 
            const height = parseFloat(element.style.height); 
            const right = left + width;
            const top = bottom + height;
            return { left, right, bottom, top, width, height };
        }

        function checkCollisionsX() {
            if (isGameOver) return;
            
            const playerHitbox = {
                left: playerX + hitboxXOffset,
                right: playerX + playerActualWidth - hitboxXOffset,
                bottom: playerY + hitboxYOffset,
                top: playerY + playerActualHeight
            };

            for (let i = gameElements.length - 1; i >= 0; i--) {
                const element = gameElements[i];
                const elementRect = getElementRect(element);

                const horizontalOverlap = playerHitbox.left < elementRect.right && playerHitbox.right > elementRect.left;
                const verticalOverlap = playerHitbox.top > elementRect.bottom && playerHitbox.bottom < elementRect.top;

                if (horizontalOverlap && verticalOverlap) {
                    if (element.classList.contains('hazard')) {
                        endGame('Bạn đã chạm chướng ngại vật nguy hiểm!');
                        return; 
                    }

                    if (element.classList.contains('obstacle') || element.classList.contains('moving-obstacle')) {
                        // Nếu đang di chuyển sang phải và va chạm
                        if (xVelocity > 0 && playerHitbox.right > elementRect.left && playerHitbox.left < elementRect.left) { 
                            playerX = elementRect.left - (playerActualWidth - hitboxXOffset); 
                            xVelocity = 0;
                        } 
                        // Nếu đang di chuyển sang trái và va chạm
                        else if (xVelocity < 0 && playerHitbox.left < elementRect.right && playerHitbox.right > elementRect.right) { 
                            playerX = elementRect.right - hitboxXOffset; 
                            xVelocity = 0;
                        }
                    }
                }
            }
        }
        
        function checkCollisionsY(previousPlayerY) {
            if (isGameOver) return; 

            let playerCurrentlyOnPlatformThisFrame = false; 
            let highestPlatformY = -Infinity; // Giữ lại vị trí Y cao nhất của nền tảng mà người chơi đang đứng trên

            const playerHitbox = {
                left: playerX + hitboxXOffset,
                right: playerX + playerActualWidth - hitboxXOffset,
                bottom: playerY + hitboxYOffset,
                top: playerY + playerActualHeight
            };
            
            // Va chạm từ dưới lên (đụng trần)
            if (yVelocity > 0) { 
                gameElements.forEach(element => {
                    if (element.classList.contains('platform') || element.classList.contains('obstacle') || element.classList.contains('moving-obstacle')) {
                        const elementRect = getElementRect(element);

                        const horizontalOverlap = (playerHitbox.right > elementRect.left && playerHitbox.left < elementRect.right);
                        
                        // Nếu nhân vật đang bay lên và đầu chạm vào đáy của một vật thể
                        if (horizontalOverlap && 
                            (previousPlayerY + playerActualHeight) <= elementRect.bottom && // Vị trí cũ dưới đáy vật thể
                            (playerY + playerActualHeight) > elementRect.bottom)            // Vị trí mới vượt qua đáy vật thể
                        {
                            playerY = elementRect.bottom - playerActualHeight; // Đẩy nhân vật xuống dưới vật thể
                            yVelocity = 0; // Dừng chuyển động lên
                            isJumping = true; // Vẫn là nhảy nhưng đã bị chặn (không cho nhảy tiếp)
                        }
                    }
                });
            }

            // Va chạm từ trên xuống (đứng trên platform)
            for (let i = gameElements.length - 1; i >= 0; i--) {
                const element = gameElements[i];
                const elementRect = getElementRect(element);

                const horizontalOverlap = (playerHitbox.right > elementRect.left && playerHitbox.left < elementRect.right);
                
                if (horizontalOverlap) {
                    // Nếu đang rơi (yVelocity <= 0) và người chơi vừa chạm/đứng trên đỉnh của nền tảng
                    if (yVelocity <= 0 && 
                        (previousPlayerY + hitboxYOffset) >= elementRect.top && // Chân người chơi ở trên hoặc bằng đỉnh platform trước đó
                        (playerY + hitboxYOffset) <= elementRect.top)           // Và chân người chơi ở hoặc dưới đỉnh platform hiện tại
                    {
                        // Kiểm tra nếu đây là một nền tảng hợp lệ để đứng
                        if (element.classList.contains('platform') || element.classList.contains('obstacle') || element.classList.contains('moving-obstacle')) {
                            if (elementRect.top > highestPlatformY) {
                                highestPlatformY = elementRect.top;
                                playerCurrentlyOnPlatformThisFrame = true;
                            }
                        }
                    }
                }
            }

            if (playerCurrentlyOnPlatformThisFrame) {
                playerY = highestPlatformY - hitboxYOffset; // Đặt vị trí chân người chơi lên đỉnh nền tảng
                yVelocity = 0;
                isJumping = false;
                isOnPlatform = true; // Đặt isOnPlatform là true khi đang đứng trên nền tảng
            } else {
                yVelocity -= gravity; // Nếu không đứng trên nền tảng nào, áp dụng trọng lực
                isOnPlatform = false; // Đặt false nếu đang không đứng trên nền tảng
            }
            
            // Kiểm tra rơi vực
            if (playerY + hitboxYOffset < deathFallThreshold && !isGameOver) { 
                endGame('Bạn đã rơi xuống vực!');
                return; 
            }
        }

        function checkWin() {
            if (isGameOver) return; 

            const finishLineRect = getElementRect(finishLine);

            const playerHitbox = {
                left: playerX + hitboxXOffset,
                right: playerX + playerActualWidth - hitboxXOffset,
                bottom: playerY + hitboxYOffset,
                top: playerY + playerActualHeight
            };

            // Kiểm tra va chạm với vạch đích
            if (playerHitbox.left < finishLineRect.right &&
                playerHitbox.right > finishLineRect.left &&
                playerHitbox.bottom < finishLineRect.top &&
                playerHitbox.top > finishLineRect.bottom ) {

                clearInterval(timerInterval);
                cancelAnimationFrame(window.animationFrameId); // Dừng game loop
                isGameOver = true;

                // Thưởng xu khi thắng level
                coinsAvailable += REWARD_PER_LEVEL;
                updateCoinDisplay();
                let winMessage = `<p>Bạn đã hoàn thành Level ${currentLevelIndex}!</p>`;
                winMessage += `<p>Bạn nhận được ${REWARD_PER_LEVEL} xu!</p>`;

                currentLevelIndex++;
                if (gameLevels['level' + currentLevelIndex]) {
                    winMessage += `<p>Chuẩn bị cho Level ${currentLevelIndex}!</p><p>Chi phí: ${COST_PER_PLAY} xu.</p><button id="next-level-button">Tiếp tục</button>`;
                    gameMessage.innerHTML = winMessage;
                    gameMessage.style.display = 'block';

                    const nextLevelButton = document.querySelector('#game-message #next-level-button');
                    if (nextLevelButton) {
                        nextLevelButton.removeEventListener('click', startNextLevel);
                        nextLevelButton.removeEventListener('touchend', (e) => { e.preventDefault(); startNextLevel(); });
                    }
                    nextLevelButton.addEventListener('click', startNextLevel);
                    nextLevelButton.addEventListener('touchend', (e) => { e.preventDefault(); startNextLevel(); });

                } else {
                    // Đã hoàn thành tất cả các level
                    endGame('Bạn đã hoàn thành tất cả các level nhận 2 xu, chơi lại cần 1 xu!');
                }
            }
        }

        function startNextLevel() {
            // Kiểm tra xu trước khi bắt đầu level tiếp theo
            if (coinsAvailable < COST_PER_PLAY) {
                showRechargeOverlay();
                return;
            }
            coinsAvailable -= COST_PER_PLAY; // Trừ xu khi bắt đầu level mới
            updateCoinDisplay();

            isGameOver = false;
            gameMessage.style.display = 'none';

            const nextLevelData = gameLevels['level' + currentLevelIndex];
            playerX = nextLevelData.initialPlayerX || 50; 
            playerY = nextLevelData.initialPlayerY || (50 - hitboxYOffset + 1); 
            xVelocity = 0;
            yVelocity = 0;
            isJumping = false;
            isMovingLeft = false;
            isMovingRight = false;
            isOnPlatform = false;
            cameraX = 0;

            loadLevel(nextLevelData);
            
            startTime = performance.now();
            elapsedTime = 0;
            timeDisplay.textContent = 'Thời gian: 00:00.00';
            clearInterval(timerInterval); 
            timerInterval = setInterval(updateTimer, 10); 

            lastFrameTime = performance.now(); 
            window.animationFrameId = requestAnimationFrame(gameLoop);

            gameInstructions.style.opacity = '1';
            gameInstructions.style.display = 'block';
            setTimeout(() => {
                gameInstructions.style.opacity = '0';
                setTimeout(() => {
                    gameInstructions.style.display = 'none';
                }, 500); 
            }, 5000); 
        }

        function endGame(message) {
            isGameOver = true;
            clearInterval(timerInterval); // Dừng timer
            cancelAnimationFrame(window.animationFrameId); // Dừng game loop

            let finalMessage = `<p>${message}</p>`;
            
            if (message.includes('hoàn thành tất cả các level')) {
                const finalTime = elapsedTime;
                winHistory.push(finalTime); 
                winHistory.sort((a, b) => a - b);
                if (winHistory.length > 5) {
                    winHistory = winHistory.slice(0, 5);
                }
                localStorage.setItem('gameWinHistory', JSON.stringify(winHistory));

                const minutes = Math.floor(finalTime / 60000);
                const seconds = Math.floor((elapsedTime % 60000) / 1000);
                const milliseconds = Math.floor((elapsedTime % 1000) / 10);
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;

                finalMessage += `<p>Tổng thời gian của bạn: ${formattedTime}</p>`;

                if (winHistory.length > 0 && finalTime === winHistory[0]) {
                    finalMessage += `<p>Kỷ lục mới!</p>`;
                }

                finalMessage += '<p>Lịch sử chiến thắng:</p><ul>';
                if (winHistory.length === 0) {
                    finalMessage += '<li>Chưa có kỷ lục nào.</li>';
                } else {
                    winHistory.forEach((time, index) => {
                        const minutes = Math.floor(time / 60000);
                        const seconds = Math.floor((time % 60000) / 1000);
                        const milliseconds = Math.floor((time % 1000) / 10);
                        const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
                        finalMessage += `<li>${index + 1}. ${formattedTime}</li>`;
                    });
                }
                finalMessage += '</ul>';

                // Sau khi hoàn thành tất cả các level, nút "Chơi Lại" sẽ đưa về level 1
                finalMessage += '<button id="reset-button">Chơi Lại</button>';
                gameMessage.innerHTML = finalMessage;
                gameMessage.style.display = 'block';

                const existingResetButton = document.querySelector('#game-message #reset-button');
                if (existingResetButton) {
                    existingResetButton.removeEventListener('click', initializeGame);
                    existingResetButton.removeEventListener('touchend', (e) => { e.preventDefault(); initializeGame(); }); 
                }
                document.querySelector('#game-message #reset-button').addEventListener('click', initializeGame);
                document.querySelector('#game-message #reset-button').addEventListener('touchend', (e) => {
                    e.preventDefault(); 
                    initializeGame();
                });

            } else { // Nếu thua (chạm hazard hoặc rơi vực)
                if (coinsAvailable < COST_PER_PLAY) {
                    finalMessage += `<p>Bạn không đủ xu để chơi lại (${COST_PER_PLAY} xu cần)!</p>`;
                    finalMessage += '<button id="recharge-from-endgame">Nạp thêm xu</button>';
                    gameMessage.innerHTML = finalMessage;
                    gameMessage.style.display = 'block';

                    const rechargeFromEndgameButton = document.querySelector('#game-message #recharge-from-endgame');
                    if (rechargeFromEndgameButton) {
                        rechargeFromEndgameButton.removeEventListener('click', showRechargeOverlay);
                        rechargeFromEndgameButton.removeEventListener('touchend', (e) => { e.preventDefault(); showRechargeOverlay(); });
                    }
                    rechargeFromEndgameButton.addEventListener('click', showRechargeOverlay);
                    rechargeFromEndgameButton.addEventListener('touchend', (e) => { e.preventDefault(); showRechargeOverlay(); });

                } else {
                    // Còn đủ xu, hiển thị nút chơi lại bình thường (sẽ trừ xu trong initializeGame)
                    finalMessage += `<p>Chơi lại cần ${COST_PER_PLAY} xu.</p>`;
                    finalMessage += '<button id="reset-button">Chơi Lại</button>';
                    gameMessage.innerHTML = finalMessage;
                    gameMessage.style.display = 'block';

                    const existingResetButton = document.querySelector('#game-message #reset-button');
                    if (existingResetButton) {
                        existingResetButton.removeEventListener('click', initializeGame);
                        existingResetButton.removeEventListener('touchend', (e) => { e.preventDefault(); initializeGame(); }); 
                    }
                    document.querySelector('#game-message #reset-button').addEventListener('click', initializeGame);
                    document.querySelector('#game-message #reset-button').addEventListener('touchend', (e) => {
                        e.preventDefault(); 
                        initializeGame();
                    });
                }
            }
        }

        function gameLoop(currentTime) {
            if (isGameOver) return;

            if (!lastFrameTime) lastFrameTime = currentTime; 
            const delta = (currentTime - lastFrameTime) / 1000; 
            lastFrameTime = currentTime;

            // Cập nhật vị trí chướng ngại vật di chuyển
            movingObstacles.forEach(obs => {
                const currentLeft = parseFloat(obs.element.style.left); 
                const maxLeft = obs.initialLeft + obs.range;
                const minLeft = obs.initialLeft;

                obs.element.style.left = currentLeft + (obs.speed * obs.direction * delta * targetFPS) + 'px';

                if (obs.direction === 1 && parseFloat(obs.element.style.left) >= maxLeft) {
                    obs.direction = -1;
                    obs.element.style.left = maxLeft + 'px'; // Đảm bảo không vượt quá giới hạn
                } else if (obs.direction === -1 && parseFloat(obs.element.style.left) <= minLeft) {
                    obs.direction = 1;
                    obs.element.style.left = minLeft + 'px'; // Đảm bảo không vượt quá giới hạn
                }
            });

            // Cập nhật vận tốc X dựa trên input
            if (isMovingLeft) {
                xVelocity = Math.max(-maxSpeed, xVelocity - moveAcceleration * delta * targetFPS);
            } else if (isMovingRight) {
                xVelocity = Math.min(maxSpeed, xVelocity + moveAcceleration * delta * targetFPS);
            } else {
                // Áp dụng ma sát chỉ khi không nhấn nút di chuyển
                if (xVelocity > 0) {
                    xVelocity = Math.max(0, xVelocity - friction * delta * targetFPS);
                } else if (xVelocity < 0) {
                    xVelocity = Math.min(0, xVelocity + friction * delta * targetFPS);
                }
            }
            
            playerX += xVelocity;
            checkCollisionsX(); 

            const previousPlayerY = playerY; // Lưu vị trí Y trước khi cập nhật
            playerY += yVelocity; 
            checkCollisionsY(previousPlayerY); // Truyền vị trí Y cũ để kiểm tra va chạm chính xác hơn

            updatePlayerPosition();

            let targetCameraX;

            const playerAnchorXOnScreen = currentEffectiveGameWidth * 0.25; 

            targetCameraX = -(playerX - playerAnchorXOnScreen); 
            
            // Làm mượt chuyển động camera
            cameraX = cameraX + (targetCameraX - cameraX) * CAMERA_SMOOTHNESS;

            // Giới hạn camera không đi quá biên của thế giới game
            const maxAllowedCameraX = 0; 
            const minAllowedCameraX = -(gameLevels['level' + currentLevelIndex].worldWidth - gameBaseWidth); // Sử dụng gameBaseWidth thay vì currentEffectiveGameWidth để camera di chuyển đúng theo thế giới game thật

            cameraX = Math.min(maxAllowedCameraX, cameraX);
            cameraX = Math.max(minAllowedCameraX, cameraX);

            gameWorld.style.transform = `translateX(${cameraX}px)`;

            checkWin(); 

            window.animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- Event Listeners cho Keyboard ---
        document.addEventListener('keydown', (event) => {
            if (isGameOver) return;
            // Chỉ chặn các phím Space, A, D
            if (['Space', 'KeyA', 'KeyD'].includes(event.code)) {
                event.preventDefault();
            }

            switch (event.code) {
                case 'KeyA':
                    isMovingLeft = true;
                    break;
                case 'KeyD':
                    isMovingRight = true;
                    break;
                case 'Space':
                    jump();
                    break;
            }
        });

        document.addEventListener('keyup', (event) => {
            if (isGameOver) return;

            switch (event.code) {
                case 'KeyA':
                    isMovingLeft = false;
                    break;
                case 'KeyD':
                    isMovingRight = false;
                    break;
            }
        });

        // --- Event Listeners cho Mobile Controls ---
        // Nút trái (portrait)
        if (leftButton) { // Kiểm tra sự tồn tại để tránh lỗi nếu không hiển thị
            leftButton.addEventListener('touchstart', (e) => { e.preventDefault(); isMovingLeft = true; });
            leftButton.addEventListener('touchend', (e) => { e.preventDefault(); isMovingLeft = false; });
        }
        // Nút phải (portrait)
        if (rightButton) {
            rightButton.addEventListener('touchstart', (e) => { e.preventDefault(); isMovingRight = true; });
            rightButton.addEventListener('touchend', (e) => { e.preventDefault(); isMovingRight = false; }); 
        }
        // Nút nhảy (portrait)
        if (jumpButton) {
            jumpButton.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });
            jumpButton.addEventListener('touchend', (e) => { e.preventDefault(); }); 
        }

        // Nút trái (landscape)
        if (leftButtonLandscape) {
            leftButtonLandscape.addEventListener('touchstart', (e) => { e.preventDefault(); isMovingLeft = true; });
            leftButtonLandscape.addEventListener('touchend', (e) => { e.preventDefault(); isMovingLeft = false; });
        }
        // Nút phải (landscape)
        if (rightButtonLandscape) {
            rightButtonLandscape.addEventListener('touchstart', (e) => { e.preventDefault(); isMovingRight = true; });
            rightButtonLandscape.addEventListener('touchend', (e) => { e.preventDefault(); isMovingRight = false; }); 
        }
        // Nút nhảy (landscape)
        if (jumpButtonLandscape) {
            jumpButtonLandscape.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });
            jumpButtonLandscape.addEventListener('touchend', (e) => { e.preventDefault(); }); 
        }


        // Hàm khởi tạo game (chỉ được gọi khi người chơi bắt đầu/chơi lại)
        function initializeGame() {
            // Đảm bảo gameMessage và rechargeOverlay ẩn đi ngay khi hàm được gọi
            gameMessage.style.display = 'none'; 
            rechargeOverlay.style.display = 'none'; 

            // Gỡ bỏ tất cả các event listeners tiềm năng trên gameMessage để tránh trùng lặp
            const buttonsInGameMessage = gameMessage.querySelectorAll('button');
            buttonsInGameMessage.forEach(button => {
                button.removeEventListener('click', initializeGame);
                button.removeEventListener('touchend', (e) => { e.preventDefault(); initializeGame(); });
                button.removeEventListener('click', showRechargeOverlay);
                button.removeEventListener('touchend', (e) => { e.preventDefault(); showRechargeOverlay(); });
                button.removeEventListener('click', startNextLevel);
                button.removeEventListener('touchend', (e) => { e.preventDefault(); startNextLevel(); });
            });


            // Logic trừ xu khi bắt đầu một lượt chơi mới
            if (coinsAvailable >= COST_PER_PLAY) {
                coinsAvailable -= COST_PER_PLAY;
                updateCoinDisplay();
            } else {
                // Nếu không đủ xu, hiển thị overlay nạp xu và dừng khởi tạo game
                showRechargeOverlay();
                return; 
            }
            
            // Reset game state
            currentLevelIndex = 1;
            loadLevel(gameLevels.level1);

            playerX = gameLevels.level1.initialPlayerX || 50;
            playerY = gameLevels.level1.initialPlayerY || (50 - hitboxYOffset + 1); 

            xVelocity = 0;
            yVelocity = 0;
            isJumping = false;
            isMovingLeft = false;
            isMovingRight = false;
            isGameOver = false; // Đặt game là đang chạy
            isOnPlatform = false; 

            playerActualWidth = playerBaseWidth;
            playerActualHeight = playerBaseHeight;
            player.classList.remove('crouching', 'in-air', 'flipped');
            facingRight = true;
            cameraX = 0; 

            startTime = performance.now();
            elapsedTime = 0;
            timeDisplay.textContent = 'Thời gian: 00:00.00';
            clearInterval(timerInterval); 
            timerInterval = setInterval(updateTimer, 10); 

            updatePlayerPosition(); 

            // Hiển thị hướng dẫn trong vài giây đầu
            gameInstructions.style.opacity = '1';
            gameInstructions.style.display = 'block';
            setTimeout(() => {
                gameInstructions.style.opacity = '0'; 
                setTimeout(() => {
                    gameInstructions.style.display = 'none';
                }, 500);
            }, 5000);

            // Bắt đầu game loop
            if (window.animationFrameId) {
                cancelAnimationFrame(window.animationFrameId);
            }
            lastFrameTime = performance.now(); 
            window.animationFrameId = requestAnimationFrame(gameLoop); 
        }

        // Hàm hiển thị màn hình bắt đầu ban đầu
        function showInitialStartScreen() {
            isGameOver = true; // Đảm bảo game không chạy trước khi người chơi xác nhận
            gameMessage.style.display = 'block';
            
            let messageContent = '';
            // Cập nhật hiển thị xu trước khi show màn hình để số xu luôn đúng
            updateCoinDisplay(); 

            if (coinsAvailable < COST_PER_PLAY) {
                messageContent = `<p>Chào mừng bạn đến với Game Pikachu!</p><p>Bạn cần ${COST_PER_PLAY} xu để bắt đầu chơi.</p><p>Bạn hiện có: ${coinsAvailable} xu.</p><button id="initial-recharge-button">Nạp thêm xu</button>`;
                gameMessage.innerHTML = messageContent;
                const initialRechargeButton = document.querySelector('#game-message #initial-recharge-button');
                if (initialRechargeButton) {
                    initialRechargeButton.removeEventListener('click', showRechargeOverlay);
                    initialRechargeButton.removeEventListener('touchend', (e) => { e.preventDefault(); showRechargeOverlay(); });
                }
                initialRechargeButton.addEventListener('click', showRechargeOverlay);
                initialRechargeButton.addEventListener('touchend', (e) => { e.preventDefault(); showRechargeOverlay(); });

            } else {
                messageContent = `<p>Chào mừng bạn đến với Game Pikachu!</p><p>Bắt đầu chơi với ${COST_PER_PLAY} xu.</p><p>Bạn hiện có: ${coinsAvailable} xu.</p><button id="start-game-button">Bắt đầu</button>`;
                gameMessage.innerHTML = messageContent;
                const startGameButton = document.querySelector('#game-message #start-game-button');
                if (startGameButton) {
                    startGameButton.removeEventListener('click', initializeGame);
                    startGameButton.removeEventListener('touchend', (e) => { e.preventDefault(); initializeGame(); });
                }
                startGameButton.addEventListener('click', initializeGame);
                startGameButton.addEventListener('touchend', (e) => { e.preventDefault(); initializeGame(); });
            }
        }

        // Gọi resizeGame và hiển thị màn hình khởi động khi trang tải xong
        document.addEventListener('DOMContentLoaded', () => {
            resizeGame(); 
            updateCoinDisplay(); // Hiển thị số xu ban đầu
            showInitialStartScreen(); // Hiển thị màn hình bắt đầu game
        });
    </script>
</body>
</html>
