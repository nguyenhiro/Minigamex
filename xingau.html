<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>MiniGamex X√≠ Ng·∫ßu - Debug Log Flow</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', Arial, sans-serif; background: #e0f2fe; color: #222; text-align: center; padding: 30px; }
        .container {
            background: white;
            margin: auto;
            padding: 2rem 1.5rem 2.5rem 1.5rem;
            border-radius: 1rem;
            max-width: 420px;
            box-shadow: 0 10px 40px #0001;
            position: relative;
        }
        h1 { color: #f59e42; font-size: 2rem; }
        .balance-blk { margin: 0 0 18px 0; font-size:1.12rem; }
        .balance-blk span { color: #10B981; font-weight: bold; }
        #connectWalletBtn, #depositBtn {
            font-size: 1rem; font-weight: bold;
            padding: 0.55rem 1.2rem; border: none; border-radius: 7px;
            margin: 0 5px 12px 5px;
        }
        #connectWalletBtn[disabled], #depositBtn[disabled] { background: #ccc; color: #666; cursor: not-allowed; }
        #connectWalletBtn { background: #6366f1; color: #fff; }
        #connectWalletBtn.connected { background: #10B981 !important; color: #fff !important; }
        #depositBtn { background: #f59e42; color: #000; }

        .bet-amount-group, .bet-group { display: flex; justify-content: center; gap: 10px; margin: 18px 0; flex-wrap: wrap; }
        .bet-button, .bet-amount-btn, #startGameBtn {
            padding: 12px 18px; border: none; border-radius: 7px; font-size: 1rem; font-weight: bold;
            cursor: pointer; background: #4caf50; color: #fff; margin-bottom: 3px; min-width: 60px;
            transition: background 0.18s;
        }
        .bet-button.selected, .bet-amount-btn.selected { background: #f59e42; color: #222; }
        .bet-button[data-bet-type=number] { background: #3b82f6; }
        .bet-button[data-bet-type=number].selected { background: #f59e42; color: #222; }

        #startGameBtn { margin: 14px 0 10px 0; background: #10B981; }
        #startGameBtn:disabled { background: #9ca3af !important; }
        .info-blk {
            margin: 10px 0 0 0;
            font-size: 1.03rem;
            color: #334155;
        }
        #timerDisplay {
            color: #f59e42;
            font-weight: bold;
            margin: 0 0 12px 0;
            font-size: 1.1rem;
            min-height: 28px;
        }
        #diceResult {
            font-size: 2.5rem;
            margin: 10px 0 10px 0;
            min-height: 48px;
            letter-spacing: 2px;
        }
        /* Modal */
        .modal-overlay {
            position: fixed; left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(44, 62, 80, 0.32);
            z-index: 1000;
            display: none;
        }
        .modal {
            position: fixed;
            left: 50%; top: 50%; transform: translate(-50%,-50%);
            background: white;
            min-width: 280px;
            max-width: 90vw;
            border-radius: 1rem;
            box-shadow: 0 10px 40px #0003;
            z-index: 1010;
            padding: 2.2rem 1.5rem 1.4rem 1.5rem;
            text-align: center;
            display: none;
            flex-direction: column;
            gap: 1.1rem;
        }
        .modal.show, .modal-overlay.show { display: flex !important; }
        .modal-title { font-size: 1.3rem; font-weight: bold; color: #f59e42; margin-bottom: 0.3rem; }
        .modal-message { font-size: 1.04rem; color: #334155; margin-bottom: 0.7rem; }
        .modal-emoji { font-size: 2.7rem; margin-bottom: 0.2rem; }
        .modal-btns { display: flex; justify-content: center; gap: 1rem; }
        .modal-btns button {
            background: #10B981; color: #fff;
            font-size: 1.08rem; font-weight: bold; border: none; border-radius: 7px;
            padding: 0.55rem 1.3rem; min-width: 110px;
        }
        .modal-btns button.secondary { background: #9ca3af; color: #222; }
        @media (max-width: 500px) {
            .container { padding: 1.2rem 0.5rem 1.5rem 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>X√≠ Ng·∫ßu</h1>
        <div>
            <button id="connectWalletBtn"><span id="walletBtnIcon">üîó</span> <span id="walletBtnText">K·∫øt n·ªëi v√≠</span></button>
            <button id="depositBtn">üí∞ N·∫°p/R√∫t Xu</button>
        </div>
        <div class="balance-blk">T·ªïng Xu: <span id="currentBalance">0</span></div>
        <div class="info-blk" id="currentBetInfo">C∆∞·ª£c: 0 Xu</div>
        <span class="bet-input-label">ƒê·∫∑t c∆∞·ª£c:</span>
        <div class="bet-amount-group" id="betAmountGroup">
            <button type="button" class="bet-amount-btn" data-amount="1">1</button>
            <button type="button" class="bet-amount-btn" data-amount="10">10</button>
            <button type="button" class="bet-amount-btn" data-amount="50">50</button>
            <button type="button" class="bet-amount-btn selected" data-amount="100">100</button>
            <button type="button" class="bet-amount-btn" data-amount="500">500</button>
        </div>
        <div class="bet-group">
            <button class="bet-button" data-bet-type="tai" data-numbers="4,5,6">T√†i (4-5-6)</button>
            <button class="bet-button" data-bet-type="xiu" data-numbers="1,2,3">X·ªâu (1-2-3)</button>
        </div>
        <div class="bet-group">
            <button class="bet-button" data-bet-type="number" data-numbers="1">1</button>
            <button class="bet-button" data-bet-type="number" data-numbers="2">2</button>
            <button class="bet-button" data-bet-type="number" data-numbers="3">3</button>
            <button class="bet-button" data-bet-type="number" data-numbers="4">4</button>
            <button class="bet-button" data-bet-type="number" data-numbers="5">5</button>
            <button class="bet-button" data-bet-type="number" data-numbers="6">6</button>
        </div>
        <button id="startGameBtn">B·∫Øt ƒë·∫ßu ch∆°i</button>
        <div id="timerDisplay"></div>
        <div id="diceResult">H√£y ƒë·∫∑t c∆∞·ª£c v√† nh·∫•n B·∫Øt ƒë·∫ßu ch∆°i!</div>
    </div>
    <!-- MODAL -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="resultModal">
        <div class="modal-title" id="modalTitle"></div>
        <div class="modal-message" id="modalMessage"></div>
        <div class="modal-emoji" id="modalEmoji"></div>
        <div class="modal-btns">
            <button id="playAgainBtn">Ch∆°i L·∫°i</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
    <script>
    // ======= CONFIG & BACKEND =======
    const BACKEND_URL = "http://localhost:3000";
    let provider, signer, userAddress = null;
    let currentBalance = 0;

    // ======= DOM =======
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const walletBtnIcon = document.getElementById('walletBtnIcon');
    const walletBtnText = document.getElementById('walletBtnText');
    const depositBtn = document.getElementById('depositBtn');
    const currentBalanceDisplay = document.getElementById('currentBalance');
    const currentBetInfo = document.getElementById('currentBetInfo');
    const timerDisplay = document.getElementById('timerDisplay');
    const diceResultDisplay = document.getElementById('diceResult');
    const betButtons = document.querySelectorAll('.bet-button');
    const betAmountBtns = document.querySelectorAll('.bet-amount-btn');
    const startGameBtn = document.getElementById('startGameBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const resultModal = document.getElementById('resultModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalEmoji = document.getElementById('modalEmoji');
    const playAgainBtn = document.getElementById('playAgainBtn');

    // ==== GAME VARS ====
    let selectedBet = null, selectedNumbers = [];
    let currentBetAmount = 100;
    let gameLocked = false, gameStarted = false;
    let timeLeft = 5;
    let timerInterval = null;

    // ======= ƒê·ªíNG B·ªò XU =======
    async function refreshBalance() {
        console.log('[LOG] G·ªçi refreshBalance');
        if (!userAddress) {
            currentBalance = 0;
            updateWalletDisplay();
            return;
        }
        try {
            const res = await fetch(`${BACKEND_URL}/balance/${userAddress}`);
            if (res.ok) {
                const data = await res.json();
                currentBalance = data.coins;
            } else currentBalance = 0;
        } catch { currentBalance = 0; }
        updateWalletDisplay();
    }
    function updateWalletDisplay() {
        console.log('[LOG] updateWalletDisplay, currentBalance =', currentBalance);
        currentBalanceDisplay.textContent = currentBalance.toLocaleString();
    }
    function updateWalletUI() {
        if (userAddress) {
            connectWalletBtn.disabled = true;
            connectWalletBtn.classList.add('connected');
            walletBtnIcon.textContent = "üü¢";
            walletBtnText.textContent = "ƒê√£ k·∫øt n·ªëi";
        } else {
            connectWalletBtn.disabled = false;
            connectWalletBtn.classList.remove('connected');
            walletBtnIcon.textContent = "üîó";
            walletBtnText.textContent = "K·∫øt n·ªëi v√≠";
        }
    }
    function setControlsBasedOnWallet() {
        const disabled = !userAddress;
        betAmountBtns.forEach(btn => btn.disabled = disabled);
        betButtons.forEach(btn => btn.disabled = disabled);
        startGameBtn.disabled = disabled;
        depositBtn.disabled = disabled;
    }
    depositBtn.addEventListener('click', () => {
        window.location.href = "https://nguyenhiro.github.io/Minigamex/deposit.html?from=xingau";
    });

    // ======= MODAL =======
    function showResultModal(title, message, emoji) {
        console.log('[LOG] showResultModal:', title, message, emoji);
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalEmoji.textContent = emoji || '';
        resultModal.classList.add("show");
        modalOverlay.classList.add("show");
    }
    function hideResultModal() {
        console.log('[LOG] hideResultModal');
        resultModal.classList.remove("show");
        modalOverlay.classList.remove("show");
    }

    // ====== GAME LOGIC ======
    function initializeGame() {
        console.log('[LOG] initializeGame - RESET UI');
        clearInterval(timerInterval);
        timeLeft = 5;
        selectedBet = null;
        selectedNumbers = [];
        gameLocked = false;
        gameStarted = false;
        currentBetAmount = 100;
        betButtons.forEach(btn => btn.classList.remove('selected'));
        betAmountBtns.forEach(btn => btn.classList.remove('selected'));
        betAmountBtns.forEach(btn => {
            if (btn.dataset.amount === "100") btn.classList.add('selected');
        });
        startGameBtn.disabled = !userAddress;
        startGameBtn.style.display = "inline-block";
        diceResultDisplay.innerHTML = 'H√£y ƒë·∫∑t c∆∞·ª£c v√† nh·∫•n B·∫Øt ƒë·∫ßu ch∆°i!';
        timerDisplay.textContent = "";
        updateWalletDisplay();
        updateBetInfo();
        hideResultModal();
        setControlsBasedOnWallet();
    }
    function updateBetInfo() {
        currentBetInfo.textContent = `C∆∞·ª£c: ${currentBetAmount ? currentBetAmount.toLocaleString() : 0} Xu`;
    }
    function startBettingPhase() {
        console.log('[LOG] B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c ƒë·∫∑t c∆∞·ª£c...');
        if (!userAddress) return;
        gameStarted = true; gameLocked = false;
        startGameBtn.disabled = true; startGameBtn.style.display = "none";
        timeLeft = 5;
        timerDisplay.textContent = `Th·ªùi gian ƒë·∫∑t c∆∞·ª£c: ${timeLeft}s`;
        timerInterval = setInterval(() => {
            timeLeft--;
            console.log('[LOG] C√≤n', timeLeft, 'gi√¢y');
            timerDisplay.textContent = `Th·ªùi gian ƒë·∫∑t c∆∞·ª£c: ${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                console.log('[LOG] H·∫øt th·ªùi gian, chu·∫©n b·ªã g·ªçi endBettingPhase', Date.now());
                setTimeout(() => {
                  console.log('[LOG] ƒê√É QUA 1 GI√ÇY SAU KHI H·∫æT TIMER', Date.now());
                  // kh√¥ng l√†m g√¨, ch·ªâ test delay
                }, 1000);
                endBettingPhase();
            }
        }, 1000);
    }
    async function endBettingPhase() {
        console.log('[LOG] ƒêang ch·∫°y endBettingPhase', Date.now());
        betButtons.forEach(btn => btn.disabled = true);
        betAmountBtns.forEach(btn => btn.disabled = true);
        gameLocked = true;
        if (!selectedBet) {
            diceResultDisplay.innerHTML = "Kh√¥ng c√≥ k·∫øt qu·∫£!";
            showResultModal("Thi·∫øu c∆∞·ª£c", "B·∫°n ch∆∞a ch·ªçn c·ª≠a ƒë·∫∑t c∆∞·ª£c!", "‚ö†Ô∏è");
            gameStarted = false;
            return;
        }
        if (currentBetAmount > currentBalance) {
            diceResultDisplay.innerHTML = "Kh√¥ng c√≥ k·∫øt qu·∫£!";
            showResultModal("Thi·∫øu xu", `B·∫°n kh√¥ng ƒë·ªß ${currentBetAmount.toLocaleString()} xu ƒë·ªÉ ƒë·∫∑t c∆∞·ª£c!`, "üí∏");
            gameStarted = false;
            return;
        }
        try {
            console.log('[LOG] G·ª≠i API ƒë·∫∑t c∆∞·ª£c /play/bet');
            let response = await fetch(`${BACKEND_URL}/play/bet`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ wallet: userAddress, betAmount: currentBetAmount })
            });
            let text = await response.text();
            let data = null;
            try { data = JSON.parse(text); } catch(e) {}
            if (!response.ok || !data || !data.success) {
                console.log('[LOG] API /play/bet l·ªói:', text);
                diceResultDisplay.innerHTML = "Kh√¥ng c√≥ k·∫øt qu·∫£!";
                showResultModal("API l·ªói", data && data.error ? data.error : text, "‚ö†Ô∏è");
                await refreshBalance();
                gameStarted = false;
                return;
            }
            await refreshBalance();
        } catch (e) {
            console.log('[LOG] L·ªói m·∫°ng/API:', e);
            diceResultDisplay.innerHTML = "Kh√¥ng c√≥ k·∫øt qu·∫£!";
            showResultModal("L·ªói m·∫°ng/API", String(e), "‚ö†Ô∏è");
            await refreshBalance();
            gameStarted = false;
            return;
        }
        // Hi·ªáu ·ª©ng x√∫c x·∫Øc
        console.log('[LOG] Hi·ªáu ·ª©ng x√∫c x·∫Øc, ch·ªù 1 gi√¢y...', Date.now());
        diceResultDisplay.innerHTML = '<span style="font-size:3.2rem;display:inline-block;animation:spin 0.7s linear;">üé≤</span>';
        setTimeout(() => {
            const result = Math.floor(Math.random() * 6) + 1;
            console.log('[LOG] Random k·∫øt qu·∫£ l√†', result, Date.now());
            diceResultDisplay.innerHTML = `<span style="font-size:2.8rem;">${result}</span>`;
            checkResult(result);
        }, 1000);
    }
    async function checkResult(result) {
        console.log('[LOG] V√†o checkResult v·ªõi k·∫øt qu·∫£', result, 'selectedBet', selectedBet, 'selectedNumbers', selectedNumbers, Date.now());
        let isWinner = false, winMultiplier = 0;
        if (selectedBet === 'tai' && result >= 4) { isWinner = true; winMultiplier = 2; }
        else if (selectedBet === 'xiu' && result <= 3) { isWinner = true; winMultiplier = 2; }
        else if (selectedBet === 'number' && selectedNumbers.includes(result)) { isWinner = true; winMultiplier = 5; }
        if (isWinner) {
            const winnings = currentBetAmount * winMultiplier;
            try {
                console.log('[LOG] B·∫°n th·∫Øng, g·ª≠i API /play/win');
                let response = await fetch(`${BACKEND_URL}/play/win`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ wallet: userAddress, winAmount: winnings })
                });
                let text = await response.text();
                let data = null;
                try { data = JSON.parse(text); } catch(e){}
                if (!response.ok || !data || !data.success) {
                    console.log('[LOG] API /play/win l·ªói:', text);
                    showResultModal("API l·ªói", data && data.error ? data.error : text, "‚ö†Ô∏è");
                } else {
                    showResultModal("Ch√∫c m·ª´ng!", `B·∫°n th·∫Øng ${winnings.toLocaleString()} xu!`, "üéâ");
                }
            } catch (e) {
                console.log('[LOG] L·ªói m·∫°ng/API khi c·ªông th∆∞·ªüng:', e);
                showResultModal("API l·ªói", String(e), "‚ö†Ô∏è");
            }
            await refreshBalance();
        } else {
            console.log('[LOG] B·∫°n thua, show modal k·∫øt qu·∫£');
            showResultModal("Thua r·ªìi!", `B·∫°n ƒë√£ thua ${currentBetAmount.toLocaleString()} xu.`, "üò¢");
            await refreshBalance();
        }
        gameStarted = false;
    }

    betButtons.forEach(btn => btn.onclick = () => {
        if (gameLocked) return;
        betButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedBet = btn.dataset.betType;
        selectedNumbers = btn.dataset.numbers.split(',').map(Number);
        console.log('[LOG] Ch·ªçn c∆∞·ª£c:', selectedBet, selectedNumbers);
    });
    betAmountBtns.forEach(btn => btn.onclick = () => {
        if (gameLocked) return;
        betAmountBtns.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        currentBetAmount = parseInt(btn.dataset.amount);
        updateBetInfo();
        console.log('[LOG] Ch·ªçn s·ªë xu c∆∞·ª£c:', currentBetAmount);
    });
    startGameBtn.onclick = function() {
        if (gameStarted) return;
        if (!userAddress) { showResultModal("Ch∆∞a k·∫øt n·ªëi v√≠", "Vui l√≤ng k·∫øt n·ªëi v√≠.", "‚ö†Ô∏è"); return; }
        if (!selectedBet) { showResultModal("Ch∆∞a ch·ªçn c·ª≠a", "B·∫°n ch∆∞a ch·ªçn c·ª≠a ƒë·∫∑t c∆∞·ª£c!", "‚ö†Ô∏è"); return; }
        if (!currentBetAmount) { showResultModal("Thi·∫øu c∆∞·ª£c", "Ch·ªçn s·ªë xu ƒë·∫∑t c∆∞·ª£c!", "‚ö†Ô∏è"); return; }
        if (currentBetAmount > currentBalance) { showResultModal("Thi·∫øu xu", "B·∫°n kh√¥ng ƒë·ªß xu!", "üí∏"); return; }
        console.log('[LOG] B·∫•m B·∫Øt ƒë·∫ßu ch∆°i');
        startBettingPhase();
    };
    playAgainBtn.onclick = () => {
        console.log('[LOG] B·∫•m n√∫t Ch∆°i L·∫°i, g·ªçi initializeGame');
        initializeGame();
    };
    modalOverlay.onclick = hideResultModal;

    connectWalletBtn.onclick = connectWallet;
    async function connectWallet() {
        if (typeof window.ethereum === 'undefined') {
            alert("B·∫°n c·∫ßn c√†i MetaMask!");
            return;
        }
        try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            if (accounts.length > 0) {
                userAddress = accounts[0].toLowerCase();
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner(userAddress);
                updateWalletUI();
                await refreshBalance();
                setControlsBasedOnWallet();
                console.log('[LOG] ƒêƒÉng nh·∫≠p v√≠ th√†nh c√¥ng, g·ªçi initializeGame');
                initializeGame();
            }
        } catch (e) {
            alert("L·ªói khi k·∫øt n·ªëi v√≠: " + (e.message || e));
        }
    }

    // ======= GI·ªêNG ƒêUA V·ªäT: KH√îNG G·ªåI L·∫†I initializeGame KHI ƒê·ªíNG B·ªò XU HO·∫∂C ƒê·ªîI V√ç =======
    document.addEventListener('DOMContentLoaded', async () => {
        if (window.ethereum) {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
                userAddress = accounts[0].toLowerCase();
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner(userAddress);
                updateWalletUI();
                await refreshBalance();
            }
        }
        setControlsBasedOnWallet();
        console.log('[LOG] Trang load xong, g·ªçi initializeGame');
        initializeGame();
    });
    window.addEventListener('focus', () => {
        console.log('[LOG] S·ª± ki·ªán window focus - refreshBalance');
        refreshBalance();
    });

    if(window.ethereum){
        window.ethereum.on('accountsChanged', async (accounts) => {
            if(accounts.length > 0){
                userAddress = accounts[0].toLowerCase();
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner(userAddress);
                updateWalletUI();
                console.log('[LOG] ƒê·ªïi account, refreshBalance');
                await refreshBalance();
            } else {
                userAddress = null;
                updateWalletUI();
                currentBalance = 0;
                updateWalletDisplay();
            }
            setControlsBasedOnWallet();
            // KH√îNG g·ªçi initializeGame ·ªü ƒë√¢y!
        });
    }
    </script>
</body>
</html>