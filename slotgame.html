<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>MiniGamex Slot 5 Reels</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('7.png') center/cover no-repeat fixed;
      padding: 30px;
      text-align: center;
    }
    .container {
      background: rgba(255,255,255,0.93);
      margin: auto;
      padding: 2rem 1.5rem;
      border-radius: 1rem;
      max-width: 700px;
      box-shadow: 0 10px 40px #0003, 0 2px 10px #2a3e4c44;
    }
    h1 { color: #f59e42; font-size: 2rem; }
    .balance-blk { font-size: 1.12rem; margin-bottom: 10px; }
    .balance-blk span { color: #10B981; font-weight: bold; }

    #connectWalletBtn, #depositBtn, #startGameBtn, .bet-amount-btn {
      font-size: 1rem; font-weight: bold;
      padding: 10px 16px; margin: 6px; border: none; border-radius: 7px;
      cursor: pointer;
    }
    #connectWalletBtn { background: #6366f1; color: white; }
    #connectWalletBtn.connected { background: #10B981 !important; }
    #depositBtn { background: #f59e42; color: black; }
    #startGameBtn { background: #10B981; color: white; margin-top: 10px; }
    #startGameBtn:disabled { background: #ccc; }

    .bet-amount-group {
      display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;
      margin: 10px 0;
    }
    .bet-amount-btn { background: #4caf50; color: white; }
    .bet-amount-btn.selected { background: #f59e42; color: black; }

    .slot-machine {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 10px;
      margin: 20px 0;
      padding: 10px;
      background: #e0e0e0;
      border-radius: 10px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
    }
    .reel {
      width: 80px;
      height: 800px; /* 8 symbols * 100px */
      border: 2px solid #ccc;
      background: #fff;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    .symbol-list {
      position: absolute;
      top: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    .symbol-list span {
      height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2.5rem;
    }

    #slotResult {
      margin-top: 10px;
      font-weight: bold;
      font-size: 1.4rem;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎰 Slot Machine - 5 Reels</h1>
    <div>
      <button id="connectWalletBtn"><span id="walletBtnIcon">🔗</span> <span id="walletBtnText">Kết nối ví</span></button>
      <button id="depositBtn">💰 Nạp/Rút Xu</button>
    </div>
    <div class="balance-blk">Tổng Xu: <span id="currentBalance">0</span></div>
    <div class="info-blk">Cược: <span id="displayBetAmount">0</span> Xu</div>
    <div class="bet-amount-group" id="betAmountGroup">
      <button type="button" class="bet-amount-btn" data-amount="2">2</button>
      <button type="button" class="bet-amount-btn" data-amount="6">6</button>
      <button type="button" class="bet-amount-btn" data-amount="10">10</button>
      <button type="button" class="bet-amount-btn" data-amount="15">15</button>
      <button type="button" class="bet-amount-btn" data-amount="20">20</button>
    </div>
    <button id="startGameBtn">🎲 Quay</button>

    <div class="slot-machine" id="slotMachine">
      <div class="reel" id="reel1"><div class="symbol-list"></div></div>
      <div class="reel" id="reel2"><div class="symbol-list"></div></div>
      <div class="reel" id="reel3"><div class="symbol-list"></div></div>
      <div class="reel" id="reel4"><div class="symbol-list"></div></div>
      <div class="reel" id="reel5"><div class="symbol-list"></div></div>
    </div>
    <div id="slotResult">Nhấn Quay để bắt đầu!</div>
  </div>
  <script>
const BACKEND_URL = "http://localhost:3000"; // Đổi nếu bạn đang dùng server khác
const connectWalletBtn = document.getElementById('connectWalletBtn');
const walletBtnText = document.getElementById('walletBtnText');
const walletBtnIcon = document.getElementById('walletBtnIcon');
const depositBtn = document.getElementById('depositBtn');
const currentBalanceDisplay = document.getElementById('currentBalance');
const betAmountBtns = document.querySelectorAll('.bet-amount-btn');
const spinButton = document.getElementById('startGameBtn');
const displayBetAmount = document.getElementById('displayBetAmount');
const slotResultDisplay = document.getElementById('slotResult');
const reels = [...Array(5)].map((_, i) => document.getElementById(`reel${i + 1}`));
const symbolLists = reels.map(reel => reel.querySelector('.symbol-list'));

let userAddress = null;
let provider, signer;
let currentBalance = 0;
let currentBetAmount = 2;
let gameLocked = false;

const symbols = ['🍒', '🍋', '🔔', '⭐', '🍀', '7️⃣'];
const REEL_HEIGHT = 100;
const SPIN_DURATION = 800;

function updateWalletUI() {
  if (userAddress) {
    connectWalletBtn.disabled = true;
    connectWalletBtn.classList.add('connected');
    walletBtnIcon.textContent = "🟢";
    walletBtnText.textContent = "Đã kết nối";
  } else {
    connectWalletBtn.disabled = false;
    connectWalletBtn.classList.remove('connected');
    walletBtnIcon.textContent = "🔗";
    walletBtnText.textContent = "Kết nối ví";
  }
}
function updateWalletDisplay() {
  currentBalanceDisplay.textContent = currentBalance.toLocaleString();
}
async function refreshBalance() {
  if (!userAddress) return;
  try {
    const res = await fetch(`${BACKEND_URL}/balance/${userAddress}`);
    const data = await res.json();
    currentBalance = data.coins || 0;
  } catch { currentBalance = 0; }
  updateWalletDisplay();
}
depositBtn.onclick = () => {
  window.location.href = "https://nguyenhiro.github.io/Minigamex/deposit.html?from=slotgame";
};
connectWalletBtn.onclick = async () => {
  if (typeof window.ethereum === 'undefined') {
    alert("Bạn cần cài MetaMask!");
    return;
  }
  try {
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    if (accounts.length > 0) {
      userAddress = accounts[0].toLowerCase();
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner(userAddress);
      updateWalletUI();
      await refreshBalance();
    }
  } catch (e) {
    alert("Lỗi khi kết nối ví: " + e.message);
  }
};

function populateReels() {
  const symbolsToShow = [];
  for (let i = 0; i < 8; i++) symbolsToShow.push(...symbols);
  symbolLists.forEach(list => {
    list.innerHTML = '';
    symbolsToShow.forEach(sym => {
      const el = document.createElement('span');
      el.textContent = sym;
      list.appendChild(el);
    });
  });
}
function updateBetInfo() {
  displayBetAmount.textContent = currentBetAmount.toLocaleString();
}
function checkResult(symbolArray) {
  let maxMatch = 1;
  let currentMatch = 1;
  for (let i = 1; i < symbolArray.length; i++) {
    if (symbolArray[i] === symbolArray[i - 1]) {
      currentMatch++;
      if (currentMatch > maxMatch) maxMatch = currentMatch;
    } else {
      currentMatch = 1;
    }
  }
  return maxMatch;
}
async function spinReels() {
  if (!userAddress) return alert("Chưa kết nối ví");
  if (currentBetAmount > currentBalance) return alert("Không đủ xu");
  if (gameLocked) return;
  gameLocked = true;
  spinButton.disabled = true;
  slotResultDisplay.textContent = "Đang quay...";
  await fetch(`${BACKEND_URL}/play/bet`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ wallet: userAddress, betAmount: currentBetAmount })
  });

  await refreshBalance();

  const finalResults = [];
  populateReels();

  const promises = reels.map((reel, i) => {
    const list = symbolLists[i];
    const targetSymbol = symbols[Math.floor(Math.random() * symbols.length)];
    finalResults.push(targetSymbol);
    const totalSpin = symbols.length * 4 + symbols.indexOf(targetSymbol);
    const finalY = -REEL_HEIGHT * totalSpin;
    list.style.transition = `transform ${SPIN_DURATION + i * 150}ms ease-out`;
    list.style.transform = `translateY(${finalY}px)`;

    return new Promise(resolve => {
      setTimeout(() => {
        list.innerHTML = '';
        const span = document.createElement('span');
        span.textContent = targetSymbol;
        list.appendChild(span);
        list.style.transition = 'none';
        list.style.transform = `translateY(0px)`;
        resolve();
      }, SPIN_DURATION + i * 150 + 100);
    });
  });

  await Promise.all(promises);
  const matchCount = checkResult(finalResults);

  let win = 0;
  if (matchCount === 2) win = currentBetAmount;
  else if (matchCount === 3) win = currentBetAmount * 2;
  else if (matchCount === 4) win = currentBetAmount * 4;
  else if (matchCount === 5) win = currentBetAmount * 10;

  if (win > 0) {
    slotResultDisplay.textContent = `🎉 Thắng ${win.toLocaleString()} xu!`;
    await fetch(`${BACKEND_URL}/play/win`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ wallet: userAddress, winAmount: win })
    });
  } else {
    slotResultDisplay.textContent = `😢 Bạn đã thua ${currentBetAmount.toLocaleString()} xu.`;
  }

  await refreshBalance();
  gameLocked = false;
  spinButton.disabled = false;
}
betAmountBtns.forEach(btn => {
  btn.onclick = () => {
    betAmountBtns.forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    currentBetAmount = parseInt(btn.dataset.amount);
    updateBetInfo();
  };
});
spinButton.onclick = spinReels;
window.addEventListener('DOMContentLoaded', () => {
  updateWalletUI();
  updateBetInfo();
  populateReels();
});
</script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
</body>
</html>
