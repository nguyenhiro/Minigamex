<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>MiniGamex Slot 5 Reels</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: url('7.png') center/cover no-repeat fixed;
      padding: 30px;
      text-align: center;
    }
    .container {
      background: rgba(255,255,255,0.93);
      margin: auto;
      padding: 2rem 1.5rem;
      border-radius: 1rem;
      max-width: 700px;
      box-shadow: 0 10px 40px #0003, 0 2px 10px #2a3e4c44;
    }
    h1 { color: #f59e42; font-size: 2rem; }
    .balance-blk { font-size: 1.12rem; margin-bottom: 10px; }
    .balance-blk span { color: #10B981; font-weight: bold; }

    #connectWalletBtn, #depositBtn, #startGameBtn, .bet-amount-btn {
      font-size: 1rem; font-weight: bold;
      padding: 10px 16px; margin: 6px; border: none; border-radius: 7px;
      cursor: pointer;
    }
    #connectWalletBtn { background: #6366f1; color: white; }
    #connectWalletBtn.connected { background: #10B981 !important; }
    #depositBtn { background: #f59e42; color: black; }
    #startGameBtn { background: #10B981; color: white; margin-top: 10px; }
    #startGameBtn:disabled { background: #ccc; }

    .bet-amount-group {
      display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;
      margin: 10px 0;
    }
    .bet-amount-btn { background: #4caf50; color: white; }
    .bet-amount-btn.selected { background: #f59e42; color: black; }

    .slot-machine {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 10px;
      margin: 20px 0;
      padding: 10px;
      background: #e0e0e0;
      border-radius: 10px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
    }
    .reel {
      width: 80px;
      height: 800px;
      border: 2px solid #ccc;
      background: #fff;
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    .symbol-list {
      position: absolute;
      top: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    .symbol-list span {
      height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2.5rem;
    }
    #slotResult {
      margin-top: 10px;
      font-weight: bold;
      font-size: 1.4rem;
      color: #333;
    }
    .result-popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #10B981;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      font-size: 1.5rem;
      font-weight: bold;
      color: #10B981;
      display: none;
      z-index: 9999;
    }
    .highlight-result {
      border: 3px solid red;
      border-radius: 6px;
      box-shadow: 0 0 10px red;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎰 Slot Machine - 5 Reels</h1>
    <div>
      <button id="connectWalletBtn"><span id="walletBtnIcon">🔗</span> <span id="walletBtnText">Kết nối ví</span></button>
      <button id="depositBtn">💰 Nạp/Rút Xu</button>
    </div>
    <div class="balance-blk">Tổng Xu: <span id="currentBalance">0</span></div>
    <div class="info-blk">Cược: <span id="displayBetAmount">0</span> Xu</div>
    <div class="bet-amount-group" id="betAmountGroup">
      <button type="button" class="bet-amount-btn" data-amount="2">2</button>
      <button type="button" class="bet-amount-btn" data-amount="6">6</button>
      <button type="button" class="bet-amount-btn" data-amount="10">10</button>
      <button type="button" class="bet-amount-btn" data-amount="15">15</button>
      <button type="button" class="bet-amount-btn" data-amount="20">20</button>
    </div>
    <button id="startGameBtn">🎲 Quay</button>

    <div class="slot-machine" id="slotMachine">
      <div class="reel" id="reel1"><div class="symbol-list"></div></div>
      <div class="reel" id="reel2"><div class="symbol-list"></div></div>
      <div class="reel" id="reel3"><div class="symbol-list"></div></div>
      <div class="reel" id="reel4"><div class="symbol-list"></div></div>
      <div class="reel" id="reel5"><div class="symbol-list"></div></div>
    </div>
    <div id="slotResult">Nhấn Quay để bắt đầu!</div>
  </div>
  <div class="result-popup" id="popupResult">🎉 Bạn thắng 50 xu!</div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>
  <script>
    const symbols = ['🍒', '🍋', '🔔', '⭐', '🍀', '7️⃣'];
    const REEL_HEIGHT = 100;
    const reels = [...Array(5)].map((_, i) => document.getElementById(`reel${i+1}`));
    const symbolLists = reels.map(reel => reel.querySelector('.symbol-list'));

    function populateReels() {
      const symbolsToShow = [];
      for (let i = 0; i < 8; i++) symbolsToShow.push(...symbols);
      symbolLists.forEach(list => {
        list.innerHTML = '';
        symbolsToShow.forEach(sym => {
          const el = document.createElement('span');
          el.textContent = sym;
          list.appendChild(el);
        });
      });
    }

    function showResultPopup(text, isWin) {
      const popup = document.getElementById('popupResult');
      popup.textContent = text;
      popup.style.borderColor = isWin ? '#10B981' : '#dc2626';
      popup.style.color = isWin ? '#10B981' : '#dc2626';
      popup.style.display = 'block';
      setTimeout(() => popup.style.display = 'none', 3000);
    }

    async function spinReels() {
      const finalResults = [];

      // Xóa highlight cũ
      document.querySelectorAll('.highlight-result').forEach(el => el.classList.remove('highlight-result'));

      populateReels();

      const promises = reels.map((reel, i) => {
        const list = symbolLists[i];
        const targetSymbol = symbols[Math.floor(Math.random() * symbols.length)];
        finalResults.push(targetSymbol);
        const totalSpin = symbols.length * 4 + symbols.indexOf(targetSymbol);
        const finalY = -REEL_HEIGHT * totalSpin;
        list.style.transition = `transform ${800 + i * 150}ms ease-out`;
        list.style.transform = `translateY(${finalY}px)`;
        return new Promise(resolve => {
          setTimeout(() => {
            list.style.transition = 'none';
            resolve();
          }, 800 + i * 150 + 100);
        });
      });

      await Promise.all(promises);

      // Tô đỏ biểu tượng trúng
      symbolLists.forEach((list, i) => {
        const children = list.querySelectorAll('span');
        const total = children.length;
        const targetSymbol = finalResults[i];
        const stopIndex = total - (symbols.length * 4 + symbols.indexOf(targetSymbol));
        const el = children[stopIndex];
        if (el) el.classList.add('highlight-result');
      });

      const resultText = `Kết quả: ${finalResults.join(' ')}`;
      const isWin = finalResults.every(s => s === finalResults[0]);
      showResultPopup(isWin ? '🎉 Bạn thắng lớn!' : '😢 Bạn chưa may mắn!', isWin);
    }

    document.getElementById('startGameBtn').onclick = spinReels;
    window.onload = populateReels;
  </script>
</body>
</html>
